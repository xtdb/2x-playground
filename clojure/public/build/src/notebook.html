<!DOCTYPE html>
<html class="overflow-hidden min-h-screen"><head><title>XTDB â€˜Core2â€™ + HoneySQL experiments</title><meta charset="UTF-8"><meta content="width=device-width, initial-scale=1" name="viewport"><script src="https://cdn.tailwindcss.com?plugins=typography" type="text/javascript"></script><script>tailwind.config = {
  darkMode: "class",
  content: ["./public/build/index.html", "./public/build/**/*.html", "./build/viewer.js"],
  safelist: ['dark'],
  theme: {
    extend: {},
    fontFamily: {
      sans: ["Fira Sans", "-apple-system", "BlinkMacSystemFont", "sans-serif"],
      serif: ["PT Serif", "serif"],
      mono: ["Fira Mono", "monospace"]
    }
  },
  variants: {
    extend: {},
  },
  plugins: [],
}
</script><style type="text/tailwindcss">@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    font-size: 18px;
  }
  @media (max-width: 600px) {
    html {
      font-size: 16px;
    }
  }
  .font-condensed { font-family: "Fira Sans Condensed", sans-serif; }
  .font-inter     { font-family: "Inter", sans-serif; }
  body {
    @apply font-serif antialiased text-gray-900 sm:overscroll-y-none;
  }
  code, .code {
    @apply font-mono text-sm text-gray-900 bg-slate-50 px-0.5 py-px rounded dark:bg-gray-800;
  }
  code::before, code::after { @apply content-none !important; }
  h1, h3, h4, h5, h6 {
    @apply font-condensed font-bold mt-8 first:mt-0;
  }
  h2 {
    /*We cannot collapse margins due to nesting but we want to*/
    /*keep the h2â€™s large margin visible*/
    @apply font-condensed font-bold mt-8 first:mt-2;
  }
  h1 { @apply text-4xl; }
  h2 { @apply text-3xl; }
  h3 { @apply text-2xl; }

  button { @apply focus:outline-none; }
  strong { @apply font-bold; }
  em     { @apply italic; }
  pre    { @apply m-0 font-mono; }
}

/* Compatibility */
/* --------------------------------------------------------------- */
/* TODO: Verify which colors are in use and replace with Tailwind
   colors accordingly. Move Nj-specific styles out of here. */

:root {
  --teal-color: #31afd0;
  --dark-teal-color: #095960;
  --near-black-color: #2e2e2c;
  --red-color: #d64242;
  --dark-blue-color: #1f2937;
  --dark-blue-60-color: rgba(28, 42, 56, 0.6);
  --gray-panel-color: rgba(239, 241, 245, 1.000);
  --brand-color: var(--dark-blue-color);
  --link-color: #5046e4;
  --command-bar-selected-color: var(--teal-color);
}

.serif      { @apply font-serif; }
.sans-serif { @apply font-sans; }
.monospace  { @apply font-mono; }
.inter      { @apply font-inter; }

.border-color-teal { border-color: var(--dark-teal-color); }
.teal { color: var(--teal-color); }
.bg-dark-blue { background: var(--dark-blue-color); }
.bg-dark-blue-60 { background: rgba(28, 42, 56, 0.6); }
.bg-gray-panel { background: var(--gray-panel-color); }
.text-dark-blue  { color: var(--dark-blue-color); }
.text-dark-blue-60 { color: var(--dark-blue-60-color); }
.border-dark-blue-30 { border-color: rgba(28, 42, 56, 0.6); }
.text-brand { color: var(--dark-blue-color); }
.bg-brand { background: var(--dark-blue-color); }
.text-selected { color: white; }
.red { color: var(--red-color); }

/* Disclose Button */
/* --------------------------------------------------------------- */

.disclose {
  @apply content-none border-solid cursor-pointer inline-block relative mr-[3px] top-[-2px] transition-all;
  border-color: var(--near-black-color) transparent;
  border-width: 6px 4px 0;
}
.disclose:hover {
  border-color: var(--near-black-color) transparent;
}
.dark .disclose,
.dark .disclose:hover {
  border-color: white transparent;
}
.disclose.collapsed {
  @apply rotate-[-90deg];
}

/* Layout */
/* --------------------------------------------------------------- */

.page {
  @apply max-w-5xl mx-auto px-12 box-border flex-shrink-0;
}
.max-w-prose { @apply max-w-[46rem] !important; }
.max-w-wide  { @apply max-w-3xl !important; }

/* List Styles */
/* --------------------------------------------------------------- */

.task-list-item + .task-list-item,
.viewer-markdown ul ul {
  @apply mt-1 mb-0;
}

/* compact TOC */
.viewer-markdown .toc ul {
  list-style: none;
  @apply my-1;
}

/* Code Viewer */
/* --------------------------------------------------------------- */

.viewer-code {
  @apply font-mono bg-slate-100 rounded-sm text-sm overflow-x-auto dark:bg-gray-800;
}
.viewer-code .cm-content {
  @apply py-4 px-8;
}
@media (min-width: 960px){
  .viewer-notebook .viewer-code .cm-content {
    @apply py-4 pl-12;
  }
}
/* Donâ€™t show focus outline when double-clicking cell in Safari */
.cm-scroller { @apply focus:outline-none; }

/* Syntax Highlighting */
/* --------------------------------------------------------------- */

.inspected-value { @apply text-xs font-mono leading-[1.25rem]; }
.cmt-strong, .cmt-heading { @apply font-bold; }
.cmt-italic, .cmt-emphasis { @apply italic; }
.cmt-strikethrough { @apply line-through; }
.cmt-link { @apply underline; }
.untyped-value { @apply whitespace-nowrap; }

.cm-editor, .cmt-default, .viewer-result {
  @apply text-slate-800 dark:text-slate-300;
}
.cmt-keyword {
  @apply text-purple-800 dark:text-pink-400;
}
.cmt-atom, .cmt-bool, .cmt-url, .cmt-contentSeparator, .cmt-labelName {
  @apply text-blue-900 dark:text-blue-300;
}
.cmt-inserted, .cmt-literal {
  @apply text-emerald-700 dark:text-emerald-200;
}
.cmt-string, .cmt-deleted {
  @apply text-rose-700 dark:text-sky-300;
}
.cmt-italic.cmt-string {
  @apply dark:text-sky-200;
}
.cmt-regexp, .cmt-escape {
  @apply text-orange-500 dark:text-orange-300;
}
.cmt-variableName {
  @apply text-blue-800 dark:text-sky-300;
}
.cmt-typeName, .cmt-namespace {
  @apply text-emerald-600 dark:text-emerald-300;
}
.cmt-className {
  @apply text-teal-600 dark:text-teal-200;
}
.cmt-macroName {
  @apply text-teal-700 dark:text-teal-200;
}
.cmt-propertyName {
  @apply text-blue-700 dark:text-blue-200;
}
.cmt-comment {
  @apply text-slate-500 dark:text-slate-400;
}
.cmt-meta {
  @apply text-slate-600 dark:text-slate-400;
}
.cmt-invalid {
  @apply text-red-500 dark:text-red-300;
}

.result-data {
  @apply font-mono text-sm overflow-x-auto whitespace-nowrap leading-normal;
}
.result-data::-webkit-scrollbar, .path-nav::-webkit-scrollbar {
  @apply h-0;
}
.result-data-collapsed {
  @apply whitespace-nowrap;
}
.result-data-field {
  @apply ml-4 whitespace-nowrap;
}
.result-data-field-link{
  @apply ml-4 whitespace-nowrap cursor-pointer;
}
.result-data-field-link:hover {
  @apply text-black bg-black/5;
}
.result-text-empty {
  color: rgba(0,0,0,.3);
}
.browsify-button:hover {
  box-shadow: -2px 0 0 2px #edf2f7;
}

/* Prose */
/* --------------------------------------------------------------- */

.viewer-notebook,
.viewer-markdown {
  @apply prose
    dark:prose-invert
    prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
    dark:prose-a:text-blue-300
    prose-p:mt-4 prose-p:leading-snug
    prose-ol:mt-4 prose-ol:mb-6 prose-ol:leading-snug
    prose-ul:mt-4 prose-ul:mb-6 prose-ul:leading-snug
    prose-blockquote:mt-4 prose-blockquote:leading-snug
    prose-hr:mt-6 prose-hr:border-t-2 prose-hr:border-solid prose-hr:border-slate-200
    prose-figure:mt-4
    prose-figcaption:mt-2 prose-figcaption:text-xs
    prose-headings:mb-4
    prose-table:mt-0
    prose-th:mb-0
    prose-img:my-0
    prose-code:font-medium prose-code:bg-slate-100
    max-w-none;
}
.viewer-markdown blockquote p:first-of-type:before,
.viewer-markdown blockquote p:last-of-type:after {
  @apply content-none;
}

/* Images */
/* --------------------------------------------------------------- */


/* Todo Lists */
/* --------------------------------------------------------------- */

.contains-task-list {
  @apply pl-6 list-none;
}
.contains-task-list input[type="checkbox"] {
  @apply appearance-none h-4 w-4 rounded border border-slate-200 relative mr-[0.3rem] ml-[-1.5rem] top-[0.15rem];
}
.contains-task-list input[type="checkbox"]:checked {
  @apply border-indigo-600 bg-indigo-600 bg-no-repeat bg-contain;
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
}

/* Markdown TOC */
/* --------------------------------------------------------------- */

.viewer-markdown .toc      { @apply mt-4; }
.viewer-markdown h1 + .toc { @apply mt-8; }

.viewer-markdown .toc h1,
.viewer-markdown .toc h2,
.viewer-markdown .toc h3,
.viewer-markdown .toc h4,
.viewer-markdown .toc h5,
.viewer-markdown .toc h6 {
  @apply text-base text-indigo-600 font-sans my-0;
}
.viewer-markdown .toc a {
  @apply text-indigo-600 font-normal no-underline hover:underline;
}
.viewer-markdown .toc li    { @apply m-0; }
.viewer-markdown .toc ul ul { @apply pl-4; }

/* Notebook Spacing */
/* --------------------------------------------------------------- */

.viewer-notebook { @apply py-16; }
#clerk-static-app .viewer-notebook { @apply pt-[0.8rem] pb-16; }
.viewer-markdown *:first-child:not(.viewer-code):not(li):not(h2) { @apply mt-0; }
/*.viewer + .viewer { @apply mt-6; }*/
.viewer + .viewer-result { @apply mt-0; }
.viewer-code + .viewer-result { @apply mt-3; }
.viewer-markdown + .viewer-markdown { @apply mt-0; }

/* Sidenotes */
/* --------------------------------------------------------------- */

.sidenote-ref {
  @apply top-[-3px] inline-flex justify-center items-center w-[18px] h-[18px]
    rounded-full bg-slate-100 border border-slate-300 hover:bg-slate-200 hover:border-slate-300
    m-0 ml-[4px] cursor-pointer;
}
.sidenote {
  @apply hidden float-left clear-both mx-[2.5%] my-4 text-xs relative w-[95%];
}
.sidenote-ref.expanded + .sidenote {
  @apply block;
}
@media (min-width: 860px) {
  .sidenote-ref {
    @apply top-[-0.5em] w-auto h-auto inline border-0 bg-transparent m-0 pointer-events-none;
  }
  .sidenote sup { @apply inline; }
  .viewer-markdown .contains-sidenotes p { @apply max-w-[65%]; }
  .viewer-markdown p .sidenote {
    @apply mr-[-54%] mt-[0.2rem] w-1/2 float-right clear-right relative block;
  }
}
.viewer-code + .viewer:not(.viewer-markdown):not(.viewer-code):not(.viewer-code-folded),
.viewer-code-folded + .viewer:not(.viewer-markdown):not(.viewer-code):not(.viewer-code-folded),
.viewer-result + .viewer-result {
  @apply mt-2;
}
.viewer-code + .viewer-code-folded {
  @apply mt-4;
}
.viewer-result {
  @apply leading-tight mb-6;
}
.viewer-result figure {
  @apply mt-0 !important;
}
@media (min-width: 768px) {
  .devcard-desc > div {
    @apply max-w-full m-0;
  }
}

/* Command Palette */
/* --------------------------------------------------------------- */

.nj-commands-input {
  @apply bg-transparent text-white;
}
.nj-context-menu-item:hover:not([disabled]) {
  @apply cursor-pointer;
  background-color: rgba(255,255,255,.14);
}

/* Devdocs */
/* --------------------------------------------------------------- */

.logo, .logo-white {
  @apply block indent-[-999em];
  background: url(/images/nextjournal-logo.svg) center center no-repeat;
}
.devdocs-body {
  @apply font-inter;
}

/* Workarounds */
/* --------------------------------------------------------------- */

/* Fixes vega viewer resizing into infinity */
.vega-embed .chart-wrapper { @apply h-auto !important; }
/* fixes fraction separators being overridden by twâ€™s border-color */
.katex * { @apply border-black; }
</style><script src="https://storage.googleapis.com/nextjournal-cas-eu/assets/28ktYzexRpt9ZsXvxpxDRnu497pkEeZjEvXB1NMVzfEoPEgsbQXEyM3j5CEucNccte6QGnX1qQxHL2KHfoBRG2FN-viewer.js" type="text/javascript"></script><link href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&amp;family=Fira+Mono:wght@400;700&amp;family=Fira+Sans+Condensed:ital,wght@0,700;1,700&amp;family=Fira+Sans:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&amp;family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet" type="text/css"></head><body><div id="clerk-static-app"></div><script>let viewer = nextjournal.clerk.sci_viewer
let app = nextjournal.clerk.static_app
let opts = viewer.read_string("{:out-path \"public/build\", :bundle? false, :browse? false, :report-fn #object[nextjournal.clerk.builder$stdout_reporter 0x53bae37a \"nextjournal.clerk.builder$stdout_reporter@53bae37a\"], :paths [\"src/notebook.clj\"], :path->doc {\"src/notebook.clj\" {:nextjournal/viewer {:name :clerk/notebook, :render-fn #viewer-fn v/notebook-viewer}, :nextjournal/value {:blocks [{:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h1\" {:id \"XTDB%20%E2%80%98Core2%E2%80%99%20+%20HoneySQL%20experiments\"} [:span \"XTDB â€˜Core2â€™ + HoneySQL experiments\"]] [:p [:span \"Welcome! \"] [:a {:href \"https://github.com/xtdb/core2\"} [:span \"Core2\"]] [:span \" is an experimental SQL-first database prototype from the \"] [:a {:href \"https://xtdb.com/\"} [:span \"XTDB\"]] [:span \" team. This namespace is a \"] [:a {:href \"https://github.com/nextjournal/clerk\"} [:span \"Clerk\"]] [:span \" \\\"notebook\\\" showcasing the existing functionality in Core2 in combination with a few other tools within the Clojure ecosystem.\"]] [:p [:span \"Please read the instructions carefully before evaluating anything, and in particular, \"] [:em [:span \"do not\"]] [:span \" immediately eval this entire namespace ðŸ™‚\"]]]} {:nextjournal/viewer {:name :code-folded, :render-fn #viewer-fn v/foldable-code-viewer}, :nextjournal/value \"^{:nextjournal.clerk/visibility {:code :fold :result :hide}}\\n(ns notebook\\n  {:nextjournal.clerk/toc true\\n   :nextjournal.clerk/open-graph\\n   {:url \\\"https://github.com/xtdb/core2-playground\\\"\\n    :title \\\"XTDB Core2 + HoneySQL experiments\\\"\\n    :description \\\"XTDB Core2 + HoneySQL experiments (powered by Clerk)\\\"\\n    :image \\\"https://cdn.nextjournal.com/data/QmbHy6nYRgveyxTvKDJvyy2VF9teeXYkAXXDbgbKZK6YRC?filename=book-of-clerk-og-image.png&content-type=image/png\\\"}}\\n  (:require [clojure.string :as str]\\n            [clojure.pprint :as pprint]\\n            [core2.api :as c2]\\n            [core2.node :as node]\\n            [core2.pgwire :as pgwire]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc :as jdbc]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.connection :as jdbcc]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.prepare :as jdbcp]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.result-set :as jdbcr]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.types :as jdbct]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.date-time :as jdbcdt]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.sql :as jsql]\\n            [juxt.clojars-mirrors.nextjdbc.v1v2v674.next.jdbc.sql.builder :as bsql]\\n            [nextjournal.clerk :as clerk]\\n            [jsonista.core :as json]\\n            [honey.sql :as sql]\\n            [honey.sql.helpers :as hsql]\\n            [portal.api :as p]\\n            [clj-test-containers.core :as tc])\\n  (:import (java.sql Connection PreparedStatement)\\n           (org.postgresql.util PGobject)\\n           (java.net URLEncoder)))\", :nextjournal/opts {:loc {:line 7, :column 1}}} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h2\" {:id \"Powered%20by%20Clerk%20%E2%9A%A1\"} [:span \"Powered by Clerk âš¡\"]] [:p [:a {:href \"https://github.com/nextjournal/clerk\"} [:span \"Clerk\"]] [:span \" is a live-programming Clojure notebook experience that makes building interactive tutorials like this one \"] [:em [:span \"easy\"]] [:span \", and running through them \"] [:em [:span \"fun\"]] [:span \"! Even if \\\"running through\\\" is read-only for now ðŸ˜… Kudos to the team behind Clerk for doing a really great job ðŸ™\"]] [:p [:span \"If you are viewing a static HTML version of this notebook then feel free to skip the next couple of sections as all the examples should be fully rendered & ready for passive consumption! Otherwise, let's continue...\"]] [\"h2\" {:id \"Booting%20up%20&%20REPL%20usage\"} [:span \"Booting up & REPL usage\"]] [:p [:span \"Before we start, let's assume you have no other Core2-related REPL open or Docker image running. Equally let's assume that you have no local Postgres instance running on port \"] [:code [:span \"5432\"]] [:span \" that might conflict.\"]] [:ol [:li [:p [:span \"Start a REPL using the instructions in \"] [:code [:span \"clojure/readme.md\"]] [:span \" and connect to it from your editor\"]]] [:li [:p [:span \"Evaluate the above ns definition in isolation first - do not eval the whole namespace!\"]]] [:li [:p [:span \"Once that has ns eval has returned, eval the initializing \"] [:code [:span \"do\"]] [:span \" block inside the first \"] [:code [:span \"comment\"]] [:span \" below (this will take some time) and then open your browser at \"] [:code [:span \"http://localhost:7777\"]] [:span \".\"]]]]]} {:nextjournal/viewer {:name :code-folded, :render-fn #viewer-fn v/foldable-code-viewer}, :nextjournal/value \"^{::clerk/visibility {:code :fold :result :hide}}\\n(do\\n  (comment ;; initializing `do` block (this will take some time)\\n    (do\\n      (clerk/clear-cache!)\\n\\n      (clerk/serve! {;;:watch-paths [\\\"src\\\"]\\n                     :browse? false}) ;; http://localhost:7777\\n      (clerk/show! \\\"src/notebook.clj\\\"))\\n    )\\n\\n  (declare my-node) ;; by default, an ephemeral Core2 node will be started up by Clerk automatically when the `serve!` command runs (after also clearing the Clerk cache)\\n\\n  (comment ;; a handy reset `do` block in case the state gets confusing\\n    (do\\n      (when (not= (type my-node) clojure.lang.Var$Unbound)\\n        (.close my-node))\\n      (clerk/halt!)\\n      (clerk/clear-cache!)\\n      (clerk/serve! {;;:watch-paths [\\\"src\\\"]\\n                     :browse? false}) ;; http://localhost:7777 - remember to refresh the webpage!\\n      (clerk/show! \\\"src/notebook.clj\\\"))\\n    ))\", :nextjournal/opts {:loc {:line 58, :column 1}}} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"If all is well (we'll confirm that soon enough) then Clerk will have already evaluated the rest of the namespace on your behalf, which includes starting up an ephemeral Core2 node (as we'll see below shortly). This means you don't need to eval any of the side-effecting forms hereafter and can focus on understanding the read-only query interactions.\"]] [:p [:span \"Unfortunately it is not recommended to use Clerk's file watcher or interactive \"] [:code [:span \"show!\"]] [:span \" facilities with this notebook at this time due to the caching and side-effect complexities. Instead you can use the REPL as normal or to see the changes in Clerk you can use the reset \"] [:code [:span \"do\"]] [:span \" block above (which is a little too slow to feel interactive).\"]] [\"h2\" {:id \"next.jdbc%20boilerplate\"} [:code [:span \"next.jdbc\"]] [:span \" boilerplate\"]] [:p [:span \"Next we'll need some boilerplate for round-tripping JSON values via \"] [:a {:href \"https://github.com/seancorfield/next-jdbc\"} [:code [:span \"next.jdbc\"]]] [:span \" and the out-of-the-box Postgres JDBC driver.\"] [#viewer-eval v/inspect-presented {:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:span \" \"]}] [:span \"These protocol extensions avoid the hassles of dealing with \"] [:code [:span \"PGobject\"]] [:span \" types directly via interop.\"]]]} {:nextjournal/viewer {:name :code-folded, :render-fn #viewer-fn v/foldable-code-viewer}, :nextjournal/value \"^{::clerk/visibility {:code :fold :result :hide}}\\n(do\\n  (def mapper (json/object-mapper {:decode-key-fn keyword}))\\n\\n  (defn ->json [v]\\n    (let [s (json/write-value-as-string v)]\\n      (if (inst? v)\\n        ;;(str \\\"DATE \\\" (subs s 0 11) \\\"\\\\\\\"\\\")\\n        (str \\\"TIMESTAMP \\\" (subs s 0 11) \\\" \\\" (subs s 12 20) \\\"\\\\\\\"\\\")\\n        s)))\\n\\n  (def <-json #(json/read-value % mapper))\\n\\n  (defn ->pgobject\\n    \\\"Transforms Clojure data to a PGobject that contains the data as\\n  JSON. PGObject type defaults to `jsonb` but can be changed via\\n  metadata key `:pgtype`\\\"\\n    [x]\\n    (let [pgtype (or (:pgtype (meta x)) \\\"jsonb\\\")]\\n      (doto (PGobject.)\\n        (.setType pgtype)\\n        (.setValue (->json x)))))\\n\\n  (defn <-pgobject\\n    \\\"Transform PGobject containing `json` or `jsonb` value to Clojure\\n  data.\\\"\\n    [^org.postgresql.util.PGobject v]\\n    (let [type  (.getType v)\\n          value (.getValue v)]\\n      (if (#{\\\"jsonb\\\" \\\"json\\\"} type)\\n        (when-let [value (<-json value)]\\n          (if (coll? value)\\n            (with-meta value {:pgtype type})\\n            value))\\n        value)))\\n\\n  (extend-protocol jdbcp/SettableParameter\\n    clojure.lang.IPersistentMap\\n    (set-parameter [m ^PreparedStatement s i]\\n      (.setObject s i (->pgobject m)))\\n\\n    clojure.lang.IPersistentVector\\n    (set-parameter [v ^PreparedStatement s i]\\n      (.setObject s i (->pgobject v))))\\n\\n  (extend-protocol jdbcr/ReadableColumn\\n    org.postgresql.util.PGobject\\n    (read-column-by-label [^org.postgresql.util.PGobject v _]\\n      (<-pgobject v))\\n    (read-column-by-index [^org.postgresql.util.PGobject v _2 _3]\\n      (<-pgobject v))))\", :nextjournal/opts {:loc {:line 91, :column 1}}} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h2\" {:id \"Start%20a%20Core2%20node\"} [:span \"Start a Core2 node\"]] [:p [:span \"Before continuing, know that three options exist for starting Core2 in this context:\"]] [:ul [:li [:<> [:span \"You can start an in-process node that exposes port \"] [:code [:span \"5432\"]] [:span \" - whilst this is convenient, Core2 is not ultimately intended for in-process usage\"]]] [:li [:<> [:span \"You can start an \"] [:code [:span \"xtdb/core2\"]] [:span \" Docker container (default pgwire port is \"] [:code [:span \"5432\"]] [:span \"), e.g. using \"] [:code [:span \"docker pull xtdb/core2:latest && docker run -p 5432:5432 xtdb/core2:latest\"]]]] [:li [:<> [:span \"You can start an \"] [:code [:span \"xtdb/core2\"]] [:span \" Docker container using Java Testcontainers that \"] [:em [:span \"feels\"]] [:span \" like it's in-process (just not quite as snappy!)\"]]]] [:p [:span \"For the purposes of this tutorial though we are starting up an ephemeral (i.e. data is not persisted across restarts) Core2 node using Java Testcontainers, and by the time you are reading this your node should have already started.\"]]]} {:nextjournal/viewer {:name :code-folded, :render-fn #viewer-fn v/foldable-code-viewer}, :nextjournal/value \"^{:nextjournal.clerk/visibility {:code :fold :result :hide}}\\n(do\\n  (declare container)\\n  (declare jdbc-config-str)\\n\\n  (defn stop-container! []\\n    (when (not= (type container) clojure.lang.Var$Unbound)\\n      (tc/stop! container)))\\n\\n  (deftype MyContainer []\\n    java.io.Closeable\\n    (close [this] (stop-container!)))\\n\\n  (defn start-container! []\\n    (stop-container!)\\n    (def container (-> (tc/create {:image-name    \\\"xtdb/core2:eb3325d8\\\"\\n                                   :exposed-ports [5432]\\n                                   :env-vars      {}})\\n                       #_(tc/bind-filesystem! {:host-path      \\\"/tmp\\\"\\n                                               :container-path \\\"/opt\\\"\\n                                               :mode           :read-only})\\n                       (tc/start!)))\\n    (def jdbc-config-str (str \\\"jdbc:postgresql://localhost:\\\" (get (:mapped-ports container) 5432) \\\"/xtdb/\\\"))\\n    (->MyContainer))\\n\\n  (defn jdbc-conn ^Connection [& params]\\n    (jdbc/get-connection jdbc-config-str))\\n\\n  (when (not= (type my-node) clojure.lang.Var$Unbound)\\n    (.close my-node))\\n\\n  (def my-node (start-container!))\\n\\n  ;; If you would prefer to connect to your own Docker container then you can comment out this entire `do` block and restart your REPL. You will probably want to restart the Docker container each time prior to evaluating the handy reset `do` block mentioned above.\\n\\n  ;; (def my-node (node/start-node {:core2/pgwire {:port 5432}})) ;; use this for in-process\\n\\n  ;; Assuming a node is now running, this `next.jdbc` snippet should be able to produce connections to it:\\n  #_(defn jdbc-conn ^Connection [& params]\\n    (jdbc/get-connection (str \\\"jdbc:postgresql://localhost:\\\"\\n                              (or (:port params) 5432)\\n                              \\\"/xtdb/\\\")))\\n  )\", :nextjournal/opts {:loc {:line 152, :column 1}}} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Let's give it a spin:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"INSERT INTO my_table (id, val) Values (123, 'foo'), ('bar', 456)\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT my_table.id, my_table.val FROM my_table\\\"]))\", :nextjournal/opts {:loc {:line 197, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 123, :path [0 0 1]}], :path [0 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :val, :path [0 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"foo\\\", :path [0 1 1]}], :path [0 1]}], :path [0]} {:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [1 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"bar\\\", :path [1 0 1]}], :path [1 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :val, :path [1 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 456, :path [1 1 1]}], :path [1 1]}], :path [1]}], :path [], :nextjournal/expanded-at {[0 1 0] false, [0 0] false, [1 0] false, [1 1] false, [0 1 1] false, [1 0 0] false, [1 1 1] false, [0 0 1] false, [] false, [0] false, [1 1 0] false, [1 0 1] false, [1] false, [0 0 0] false, [0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"...did it return \"] [:code [:span \"[{:id 123 :val \\\"foo\\\"} {:id \\\"bar\\\" :val 456}]\"]] [:span \" ? Hopefully! If you are seeing multiple such entries then you are likely witnessing the effect of repeated evaluations of the above combined with Core2's default application-time visibility (across all versions). This isn't a problem, although you may wish to restart your node to reset the database state as the notebook has gotten out of sync.\"]] [\"h2\" {:id \"Core2%20101\"} [:span \"Core2 101\"]] [:p [:span \"Despite using the Postgres wire protocol ('pgwire') exclusively in this tutorial (for now...\"] [:a {:href \"https://arrow.apache.org/blog/2022/02/16/introducing-arrow-flight-sql/\"} [:span \"FlightSQL is coming soon\"]] [:span \"!), Core2 is very different to Postgres and is not seeking to be directly compatible with it. Instead Core2 implements a novel SQL dialect based primarily on the published standards but with some carefully chosen additions, with the main objective of bringing the key principles embodied in XTDB 1.xâ€‰â€”â€‰immutability, schemaless records, and temporal queryingâ€‰â€”â€‰to a mainstream SQL audience.\"]] [:p [:span \"Let's review the things that make Core2 relatively unique in the world of SQL:\"]] [\"h3\" {:id \"Instant%20Schemaless%20Writes\"} [:span \"Instant Schemaless Writes\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"INSERT INTO posts (id, user_id, text)\\n                             VALUES (1234, 5678, 'Hello World!')\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT posts.text FROM posts\\\"]))\", :nextjournal/opts {:loc {:line 211, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Hello World!\\\", :path [0 0 1]}], :path [0 0]}], :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false, [0 0] false, [0 0 0] false, [0 0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Core2 does not require any pre-defined schema or tables. Yet at the same time every insert, update, and delete is immutable, as we'll see shortly.\"]] [\"h3\" {:id \"First-Class%20Arrays%20and%20Objects\"} [:span \"First-Class Arrays and Objects\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"INSERT INTO people (id, name, friends)\\n                             VALUES (5678, 'Sarah',\\n                                     [{'user': 'Dan'},\\n                                      {'user': 'Kath'}])\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT people.friends[2] AS friend FROM people\\\"]))\", :nextjournal/opts {:loc {:line 220, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :friend, :path [0 0 0]} {:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :user, :path [0 0 1 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Kath\\\", :path [0 0 1 0 1]}], :path [0 0 1 0]}], :path [0 0 1]}], :path [0 0]}], :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false, [0 0] false, [0 0 0] false, [0 0 1] false, [0 0 1 0] false, [0 0 1 0 0] false, [0 0 1 0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Nested data is handled natively. Objects are not opaque or reduced to a subset of types (i.e. unlike Postgres' JSONB). Instead nested data is seamlessly integrated with SQL using a familiar feeling syntax.\"]] [\"h3\" {:id \"Enhanced%20SQL:2011\"} [:span \"Enhanced SQL:2011\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"INSERT INTO posts (id, user_id, text)\\n                             VALUES (1234, 5678, 'Hello Bitemporality!')\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT posts.text FROM posts\\\"]))\", :nextjournal/opts {:loc {:line 231, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Hello World!\\\", :path [0 0 1]}], :path [0 0]}], :path [0]} {:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [1 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Hello Bitemporality!\\\", :path [1 0 1]}], :path [1 0]}], :path [1]}], :path [], :nextjournal/expanded-at {[0 0] false, [1 0] false, [1 0 0] false, [0 0 1] false, [] false, [0] false, [1 0 1] false, [1] false, [0 0 0] false}}\"}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"SET APPLICATION_TIME_DEFAULTS TO AS_OF_NOW\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT posts.text FROM posts\\\"]))\", :nextjournal/opts {:loc {:line 236, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Hello Bitemporality!\\\", :path [0 0 1]}], :path [0 0]}], :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false, [0 0] false, [0 0 0] false, [0 0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Core2 defaults to the SQL:2011 standard behaviours for inserting and querying \\\"across all time\\\", but it also offers optional defaults for a more intuitive experience.\"]] [\"h3\" {:id \"Cross-Time%20Queries\"} [:span \"Cross-Time Queries\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"SET APPLICATION_TIME_DEFAULTS TO AS_OF_NOW\\\"])\\n  (jdbc/execute! my-conn [\\\"INSERT INTO posts (id, user_id, text, application_time_start)\\n                             VALUES (9012, 5678, 'Happy 2025!', DATE '2025-01-01')\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT posts.text FROM posts\\\"]) ;; returns just 1 entry as-of 'now'\\n  (jdbc/execute! my-conn [\\\"SELECT posts.text FROM posts\\n                             FOR APPLICATION_TIME AS OF DATE '2025-01-02'\\\"])) ;; returns the future entry also\", :nextjournal/opts {:loc {:line 244, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Hello Bitemporality!\\\", :path [0 0 1]}], :path [0 0]}], :path [0]} {:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [1 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"Happy 2025!\\\", :path [1 0 1]}], :path [1 0]}], :path [1]}], :path [], :nextjournal/expanded-at {[0 0] false, [1 0] false, [1 0 0] false, [0 0 1] false, [] false, [0] false, [1 0 1] false, [1] false, [0 0 0] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Thinking about time in Core2 is optional â€“ but rest assured that it is universal. Advanced applications can even query time itself.\"]] [\"h3\" {:id \"Native%20Apache%20Arrow\"} [:span \"Native Apache Arrow\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"SELECT more_posts.text\\n                             FROM ARROW_TABLE('https://xtdb.com/more_posts.arrow')\\n                             AS more_posts\\\"]))\", :nextjournal/opts {:loc {:line 256, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :text, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"We love strangeloop\\\", :path [0 0 1]}], :path [0 0]}], :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false, [0 0] false, [0 0 0] false, [0 0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Core2 speaks \"] [:a {:href \"https://arrow.apache.org/\"} [:span \"Apache Arrow\"]] [:span \" as readily as it speaks SQL. The internal architecture also uses Apache Arrow extensively to unlock possibilities for future development and high-performance integration.\"]] [\"h3\" {:id \"Complete%20Erasure\"} [:span \"Complete Erasure\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"ERASE FROM people WHERE people.id=5678\\\"])\\n  (jdbc/execute! my-conn [\\\"SELECT people.id FROM people\\\"]))\", :nextjournal/opts {:loc {:line 265, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [], :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"To comply with privacy laws, erasure is necessary when handling otherwise immutable data.\"]] [\"h2\" {:id \"Behaviours%20to%20be%20aware%20of\"} [:span \"Behaviours to be aware of\"]] [:p [:span \"In addition to some \"] [:a {:href \"https://core2docs.xtdb.com/\"} [:span \"preliminary documentation\"]] [:span \", which is worth a quick look, there are some caveats about Core2's current behaviour worth mentioning here:\"]] [:ul [:li [:<> [:span \"all data is returned as JSON by the pgwire driver, regardless of the native storage types being used internally (e.g. you can insert a DATE but will be returned as an ISO string)\"]]] [:li [:<> [:span \"INSERTs cannot return any data, including counts of modified rows\"]]] [:li [:<> [:span \"all columns must be fully-qualified in queries\"]]] [:li [:<> [:span \"there is no user-facing information schema, and \"] [:code [:span \"SELECT *\"]] [:span \" will only return columns referenced in a query\"]]] [:li [:<> [:span \"rows will be filtered out where a column is SELECTed and the given row has no value stored for the column\"]]] [:li [:<> [:span \"duplicate column names across separate tables do not work, see \"] [:a {:href \"https://github.com/xtdb/core2/issues/535\"} [:span \"https://github.com/xtdb/core2/issues/535\"]]]]] [\"h2\" {:id \"HoneySQL%20101\"} [:span \"HoneySQL 101\"]] [:p [:span \"As per the description in HoneySQL's \"] [:a {:href \"https://github.com/seancorfield/honeysql\"} [:span \"readme\"]] [:span \", HoneySQL is: \\\"SQL as Clojure data structures. Build queries programmatically -- even at runtime -- without having to bash strings together.\\\"\"]] [:p [:span \"To familiarise yourself with HoneySQL it is worth giving that readme a skim now and keep the documentation open as you continue working through this namespace.\"]] [:p [:span \"Adapting our example:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn (sql/format {:select [:my-table.id\\n                                               :my-table.val]\\n                                      :from :my-table})))\", :nextjournal/opts {:loc {:line 288, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 123, :path [0 0 1]}], :path [0 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :val, :path [0 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"foo\\\", :path [0 1 1]}], :path [0 1]}], :path [0]} {:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [1 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"bar\\\", :path [1 0 1]}], :path [1 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :val, :path [1 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 456, :path [1 1 1]}], :path [1 1]}], :path [1]}], :path [], :nextjournal/expanded-at {[0 1 0] false, [0 0] false, [1 0] false, [1 1] false, [0 1 1] false, [1 0 0] false, [1 1 1] false, [0 0 1] false, [] false, [0] false, [1 1 0] false, [1 0 1] false, [1] false, [0 0 0] false, [0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"You can also preview the SQL by calling \"] [:code [:span \"sql/format\"]] [:span \" in isolation:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(sql/format {:select [:my-table.id\\n                      :my-table.val]\\n             :from :my-table}\\n            {:pretty true})\", :nextjournal/opts {:loc {:line 294, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"\\\\nSELECT my_table.id, my_table.val\\\\nFROM my_table\\\\n\\\", :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"We can create a couple of helper functions to improve the interactive experience as we embark on our HoneySQL adventure:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(def f sql/format) ;; f for f-ormat\", :nextjournal/opts {:loc {:line 300, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[honey.sql$format 0x48c1b99e \\\\\\\"honey.sql$format@48c1b99e\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn q [m & [c]] ;; q for q-uery\\n  ^::clerk/no-cache\\n  (let [_exec-count c]\\n    (with-open [my-conn (jdbc-conn)]\\n      (jdbc/execute! my-conn [\\\"SET APPLICATION_TIME_DEFAULTS TO AS_OF_NOW\\\"]) ;; let's always use this from now on\\n      (jdbc/execute! my-conn (sql/format m)))))\", :nextjournal/opts {:loc {:line 302, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$q 0x33c432a9 \\\\\\\"notebook$q@33c432a9\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Much easier on the eyes:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(q {:select [:my-table.id\\n             :my-table.val]\\n    :from :my-table\\n    :where [:= :my-table.val 456]})\", :nextjournal/opts {:loc {:line 311, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"bar\\\", :path [0 0 1]}], :path [0 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :val, :path [0 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 456, :path [0 1 1]}], :path [0 1]}], :path [0]}], :path [], :nextjournal/expanded-at {[] false, [0] false, [0 0] false, [0 0 0] false, [0 0 1] false, [0 1] false, [0 1 0] false, [0 1 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h3\" {:id \"Temporary%20HoneySQL%20boilerplate\"} [:span \"Temporary HoneySQL boilerplate\"]] [:p [:span \"HoneySQL also offers higher-level functions for inserting and retrieving data. To cope with Core2's current limitations however we will use a slightly modified version of HoneySQL's \"] [:code [:span \"insert!\"]] [:span \" which sidesteps parameter typing issues (and similarly when attempting to use \"] [:code [:span \":insert-into\"]] [:span \").\"]]]} {:nextjournal/viewer {:name :code-folded, :render-fn #viewer-fn v/foldable-code-viewer}, :nextjournal/value \"^{:nextjournal.clerk/visibility {:code :fold :result :hide}}\\n(do\\n  (defn single-quotify [s]\\n    (str/replace s #\\\"\\\\\\\"\\\" \\\"'\\\"))\\n\\n  (defn for-insert*\\n    \\\"don't use prepared parameters to avoid type handling, skip table `safe-name` check (it's a private fn)\\\"\\n    [table key-map opts]\\n    (let [entity-fn (:table-fn opts identity)\\n          params    (bsql/as-keys key-map opts)]\\n      (assert (seq key-map) \\\"key-map may not be empty\\\")\\n      (into [(str \\\"INSERT INTO \\\" (entity-fn (name table))\\n                  \\\" (\\\" params \\\")\\\"\\n                  \\\" VALUES (\\\" (single-quotify (str/join \\\", \\\" (map ->json (vals key-map)))) \\\")\\\"\\n                  (when-let [suffix (:suffix opts)]\\n                    (str \\\" \\\" suffix)))])))\\n\\n  (defn insert!*\\n    \\\"overriding for-insert\\\"\\n    ([connectable table key-map]\\n     (insert!* connectable table key-map {}))\\n    ([connectable table key-map opts]\\n     (let [opts (merge (:options connectable) opts)]\\n       (prn (for-insert* table key-map opts))\\n       (jdbc/execute-one! connectable\\n                          (for-insert* table key-map opts)\\n                          (merge {:return-keys false} opts)))))\\n\\n  (defn insert! [table key-map]\\n    (with-open [my-conn (jdbc-conn)]\\n      (insert!* my-conn table key-map jdbc/snake-kebab-opts))))\", :nextjournal/opts {:loc {:line 320, :column 1}}} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h2\" {:id \"SQL:2011%20/%20snodgrass-99\"} [:span \"SQL:2011 / \"] [:code [:span \"snodgrass-99\"]]] [:p [:span \"One of the big motivations behind Core2 is the desire to offer the full suite of temporal functionality seen in the \"] [:a {:href \"https://en.wikipedia.org/wiki/SQL:2011\"} [:span \"SQL:2011\"]] [:span \" revision of the SQL standard.\"] [#viewer-eval v/inspect-presented {:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:span \" \"]}] [:span \"To illustrate the purpose of bitemporal modelling and the usage of the SQL:2011 functionality, the following examples have been adapted from \"] [:code [:span \"bitemporal/snodgrass.sql\"]] [:span \" (which is a more extensive resource located in this same \"] [:code [:span \"core2-playground\"]] [:span \" repository).\"]] [:ul [:li [:<> [:span \"Derived from \\\"Developing Time-Oriented Database Applications in SQL\\\" by Richard T. Snodgrass.\"]]] [:li [:<> [:span \"A digital copy of the book is available freely online from the author @ \"] [:a {:href \"https://www2.cs.arizona.edu/~rts/tdbbook.pdf\"} [:span \"https://www2.cs.arizona.edu/~rts/tdbbook.pdf\"]]]] [:li [:<> [:span \"This tutorial is based on the examples in Chapter 10 (p301 of the pdf)\"]]] [:li [:<> [:span \"Various excerpts have been adapted and included below. However, the source material (the book) is worth heavily referring to for the complete context, and to compare the differences side-by-side between the SQL-92 examples and Core2's SQL:2011 implementation.\"]]] [:li [:<> [:span \"Use of the \"] [:a {:href \"https://bitemporal-visualizer.github.io/\"} [:span \"Bitemporal Visualizer\"]] [:span \" is recommended.\"]]]] [\"h3\" {:id \"Background%20(excerpt)\"} [:span \"Background (excerpt)\"]] [:p [:span \"Information is the key asset of many companies. Nykredit, a major Danish mortgage bank, is a good example. In 1989, the Danish legislature changed the Mortgage Credit Act to allow mortgage providers to market loans directly to customers and through real estate agents\"]] [:p [:span \"One of the challenges was achieving high data quality on the customers and their loans, while expanding the traditional focus to also include customer support. Managers needed access to up-to-date data to set benchmarks an identify problems in various areas of the business. The sheer volume of the data, nine million loans to eight million customers concerning seven million properties, demands that eliminating errors in the data must be highly efficient.\"]] [:p [:span \"It was mandated that changes to critical tables be tracked. This implies that the tables have system-time support. As these tables also model changes in reality, they require application-time support. The result is termed a bitemporal table, reflecting these two aspects of underlying temporal support. With such tables, IT personnel can first determine when the erroneous data was stored (a system time), roll back the table to that point, and look at the application-time history. They can then determine what the correct application-time history should be. At that point, they can tell the customer service person what needs to be changed, or if the error was in the processing of a user transaction, they may update the database manually.\"]] [\"h3\" {:id \"%5B10.2%5D%20MODIFICATIONS\"} [:span \"[10.2] MODIFICATIONS\"]] [:p [:span \"Let's follow the history, over both application time and system time, of a flat in Aalborg, at Skovvej 30 for the month of January 1998.\"]] [:p [:span \"Starting with Current Modifications (Inserts, Updates, Deletes)\"]] [:p [:span \"For Core2 an explicit ID is needed, let's not complicate everything with UUIDs for now and assume we are talking about flat '1'...\"]] [\"h4\" {:id \"%5BMOD1%5D%20Eva%20Nielsen%20buys%20the%20flat%20at%20Skovvej%2030%20in%20Aalborg%20on%20January%2010,%201998.\"} [:span \"[MOD1] Eva Nielsen buys the flat at Skovvej 30 in Aalborg on January 10, 1998.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(insert! :prop-owner {:id 1\\n                      :customer-number 145\\n                      :property-number 7797\\n                      :application-time-start #inst \\\"1998-01-10\\\"})\", :nextjournal/opts {:loc {:line 380, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Here we have but one region, associated with Eva Nielsen, that starts today in system time and extends to until changed, and that begins also at time 10 in application time and extends to forever.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(q {:select [:x.id\\n             :x.customer-number\\n             :x.application-time-start\\n             :x.application-time-end\\n             :x.system-time-start\\n             :x.system-time-end]\\n    :from [[:prop-owner :x]]\\n    :where [[:= :x.id 1]]})\", :nextjournal/opts {:loc {:line 386, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :application_time_end, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"9999-12-31T23:59:59.999999Z\\\", :path [0 0 1]}], :path [0 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :application_time_start, :path [0 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"1998-01-10T00:00Z\\\", :path [0 1 1]}], :path [0 1]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :customer_number, :path [0 2 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 145, :path [0 2 1]}], :path [0 2]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :id, :path [0 3 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 1, :path [0 3 1]}], :path [0 3]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :system_time_end, :path [0 4 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"9999-12-31T23:59:59.999999Z\\\", :path [0 4 1]}], :path [0 4]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :system_time_start, :path [0 5 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"2022-11-30T14:18:30.692186Z\\\", :path [0 5 1]}], :path [0 5]}], :path [0]}], :path [], :nextjournal/expanded-at {[0 1 0] false, [0 0] false, [0 1 1] false, [0 5] false, [0 4 1] false, [0 0 1] false, [] false, [0 2 0] false, [0 5 0] false, [0] false, [0 3] false, [0 2] false, [0 4] false, [0 3 1] false, [0 3 0] false, [0 4 0] false, [0 0 0] false, [0 2 1] false, [0 5 1] false, [0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"To avoid repetition, let's factor out the time columns and use short aliases:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(def time-cols [[:x.application-time-start :app-start]\\n                [:x.application-time-end :app-end]\\n                [:x.system-time-start :sys-start]\\n                [:x.system-time-end :sys-end]])\", :nextjournal/opts {:loc {:line 396, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :x.application-time-start, :path [0 0]} {:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :app-start, :path [0 1]}], :path [0]} {:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :x.application-time-end, :path [1 0]} {:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :app-end, :path [1 1]}], :path [1]} {:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :x.system-time-start, :path [2 0]} {:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :sys-start, :path [2 1]}], :path [2]} {:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\" \\\"]\\\"), :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :x.system-time-end, :path [3 0]} {:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :sys-end, :path [3 1]}], :path [3]}], :path [], :nextjournal/expanded-at {[0 0] false, [1 0] false, [1 1] false, [3 0] false, [] false, [3] false, [0] false, [2 0] false, [3 1] false, [2 1] false, [2] false, [1] false, [0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"^{::clerk/viewer show-raw-value} ;; Clerk allows you define custom viewers to pretty-print the raw edn too\\n(q {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[:prop-owner :x]]\\n    :where [[:= :x.id 1]]})\", :nextjournal/opts {:loc {:line 401, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \\\"[{:customer_number 145,\\\\n  :app_start \\\\\\\"1998-01-10T00:00Z\\\\\\\",\\\\n  :app_end \\\\\\\"9999-12-31T23:59:59.999999Z\\\\\\\",\\\\n  :sys_start \\\\\\\"2022-11-30T14:18:30.692186Z\\\\\\\",\\\\n  :sys_end \\\\\\\"9999-12-31T23:59:59.999999Z\\\\\\\"}]\\\\n\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :code}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Let's print the output in a string format suitable for copying across to the \"] [:a {:href \"https://bitemporal-visualizer.github.io/\"} [:span \"Bitemporal Visualizer\"]] [:span \":\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(clerk/html [:pre (-> (q {:select (into [:x.id\\n                                         :x.customer-number]\\n                                        time-cols)\\n                          :from [[:prop-owner :x]]})\\n                      pprint/print-table\\n                      with-out-str\\n                      (subs 1))])\", :nextjournal/opts {:loc {:line 408, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:pre \\\"| :id | :customer_number |        :app_start |                    :app_end |                  :sys_start |                    :sys_end |\\\\n|-----+------------------+-------------------+-----------------------------+-----------------------------+-----------------------------|\\\\n|   1 |              145 | 1998-01-10T00:00Z | 9999-12-31T23:59:59.999999Z | 2022-11-30T14:18:30.692186Z | 9999-12-31T23:59:59.999999Z |\\\\n\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"This calls for another notebook helper function to avoid repetition:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn t [m & [c]] ;; t for t-able\\n  ^::clerk/no-cache\\n  (clerk/html [:pre (-> (q m c)\\n                        pprint/print-table\\n                        with-out-str\\n                        (#(if (= (count %) 0) \\\" \\\" %))\\n                        (subs 1))]))\", :nextjournal/opts {:loc {:line 417, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$t 0x1e3f6113 \\\\\\\"notebook$t@1e3f6113\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"And while we're at it we can pipe that table into a hyperlink that directly opens the Visualizer in a new tab and displays the data:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn link [m & [c]]\\n  ^::clerk/no-cache\\n  (str \\\"https://bitemporal-visualizer.github.io/?t=\\\"\\n       (-> (q m c)\\n           pprint/print-table\\n           with-out-str\\n           (#(if (= (count %) 0) \\\" \\\" %))\\n           (subs 1)\\n           (URLEncoder/encode \\\"UTF-8\\\"))))\", :nextjournal/opts {:loc {:line 426, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$link 0x1c1985ff \\\\\\\"notebook$link@1c1985ff\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn l [m & [c]] ;; l for l-ink\\n  ^::clerk/no-cache\\n  (clerk/html [:a {:href (link m c)\\n                   :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"]))\", :nextjournal/opts {:loc {:line 436, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$l 0x33836f95 \\\\\\\"notebook$l@33836f95\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"For example...\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(l {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[:prop-owner :x]]\\n    :where [[:= :x.id 1]]}\\n   1)\", :nextjournal/opts {:loc {:line 442, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:a {:href \\\"https://bitemporal-visualizer.github.io/?t=%7C+%3Acustomer_number+%7C++++++++%3Aapp_start+%7C++++++++++++++++++++%3Aapp_end+%7C++++++++++++++++++%3Asys_start+%7C++++++++++++++++++++%3Asys_end+%7C%0A%7C------------------%2B-------------------%2B-----------------------------%2B-----------------------------%2B-----------------------------%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.692186Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A\\\", :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Note the use of the added \"] [:code [:span \"exec-count\"]] [:span \" parameter getting passed through here, we'll use this (e.g. manually increment) to avoid picking up Clerk's cached evaluations from previous executions of any given query.\"]] [:p [:span \"Use the visualization tool liberally from now on to help reason about the history and compare against the diagrams seen in the book. With only one entry here for the moment though the visualization is just a big boring black rectangle.\"]] [\"h4\" {:id \"%5BMOD2%5D%20Peter%20Olsen%20buys%20the%20flat;%20this%20legal%20system%20transfers%20ownership%20from%20Eva%20to%20him\"} [:span \"[MOD2] Peter Olsen buys the flat; this legal system transfers ownership from Eva to him\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(insert! :prop-owner {:id 1\\n                      :customer-number 827\\n                      :property-number 7797\\n                      :application-time-start #inst \\\"1998-01-15\\\"})\", :nextjournal/opts {:loc {:line 453, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Observe the change in ownership as-of 'now' along with the new application-time-start:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(t {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[:prop-owner :x]]\\n    :where [[:= :x.id 1]]}\\n   1)\", :nextjournal/opts {:loc {:line 459, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:pre \\\"| :customer_number |        :app_start |                    :app_end |                  :sys_start |                    :sys_end |\\\\n|------------------+-------------------+-----------------------------+-----------------------------+-----------------------------|\\\\n|              827 | 1998-01-15T00:00Z | 9999-12-31T23:59:59.999999Z | 2022-11-30T14:18:30.996587Z | 9999-12-31T23:59:59.999999Z |\\\\n\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"To see the \"] [:em [:span \"full\"]] [:span \" history with our Core2-specific application_time_defaults with vanilla HoneySQL we can do it like this:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(t {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\" FOR ALL SYSTEM_TIME FOR ALL APPLICATION_TIME\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   2)\", :nextjournal/opts {:loc {:line 466, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:pre \\\"| :customer_number |        :app_start |                    :app_end |                  :sys_start |                    :sys_end |\\\\n|------------------+-------------------+-----------------------------+-----------------------------+-----------------------------|\\\\n|              145 | 1998-01-10T00:00Z | 9999-12-31T23:59:59.999999Z | 2022-11-30T14:18:30.692186Z | 2022-11-30T14:18:30.996587Z |\\\\n|              145 | 1998-01-10T00:00Z |           1998-01-15T00:00Z | 2022-11-30T14:18:30.996587Z | 9999-12-31T23:59:59.999999Z |\\\\n|              827 | 1998-01-15T00:00Z | 9999-12-31T23:59:59.999999Z | 2022-11-30T14:18:30.996587Z | 9999-12-31T23:59:59.999999Z |\\\\n\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Note there a 3 entries. This is because the original validity region needed \\\"splitting\\\" into two parts, so that the later part could be overridden by the new value. Try changing the \"] [:code [:span \"t\"]] [:span \" to \"] [:code [:span \"l\"]] [:span \" to visualize this result.\"]] [:p [:span \"Ultimately it will be great for HoneySQL to offer first-class support in \"] [:code [:span \":from\"]] [:span \" for the SQL:2011 table period specifications rather than using \"] [:code [:span \":raw\"]] [:span \" (which is a powerful escape hatch).\"]] [\"h4\" {:id \"%5BMOD3%5D%20We%20perform%20a%20current%20deletion%20when%20we%20find%20out%20that%20Peter%20has%20sold%20the%20property%20to%20someone%20else\"} [:span \"[MOD3] We perform a current deletion when we find out that Peter has sold the property to someone else\"]] [:p [:span \"The buyer has the mortgage handled by another mortgage company. From the bank's point of view, the property no longer exists as of(an application time of) now.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"SET APPLICATION_TIME_DEFAULTS TO AS_OF_NOW\\\"])\\n  (jdbc/execute! my-conn [\\\"\\nDELETE\\nFROM prop_owner\\nFOR PORTION OF APPLICATION_TIME FROM DATE '1998-01-20' TO END_OF_TIME\\nWHERE prop_owner.property_number = 7797\\\"]))\", :nextjournal/opts {:loc {:line 480, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [], :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Note that using \"] [:code [:span \"next.jdbc\"]] [:span \"'s \"] [:code [:span \"delete!\"]] [:span \" (instead of this string DML) will require similar shenanigans like \"] [:code [:span \"insert!\"]] [:span \" above. (TODO)\"]] [:p [:span \"See that the current view is deleted with the following returning 0 rows:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(q {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[:prop-owner :x]]\\n    :where [[:= :x.id 1]]}\\n   3)\", :nextjournal/opts {:loc {:line 491, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [], :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"If we now request the application-time history as best known, we will learn that Eva owned the at from January 10 to January 15, and Peter owned the at from January 15 to January 20. Note that all prior states are retained. We can still time-travel back to January 18 and request the application-time history, which will state that on that day we thought that Peter still owned the at.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(l {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\"  FOR ALL SYSTEM_TIME FOR ALL APPLICATION_TIME\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   4)\", :nextjournal/opts {:loc {:line 499, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:a {:href \\\"https://bitemporal-visualizer.github.io/?t=%7C+%3Acustomer_number+%7C++++++++%3Aapp_start+%7C++++++++++++++++++++%3Aapp_end+%7C++++++++++++++++++%3Asys_start+%7C++++++++++++++++++++%3Asys_end+%7C%0A%7C------------------%2B-------------------%2B-----------------------------%2B-----------------------------%2B-----------------------------%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.692186Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+++++++++++1998-01-15T00%3A00Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+++++++++++1998-01-20T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A\\\", :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"When visualized, the current deletion has \\\"chopped off\\\" the top-right corner, so that the region is now L-shaped.\"]] [\"h4\" {:id \"%5BMOD4%5D%20A%20sequenced%20insertion%20performed%20on%20January%2023:%20Eva%20actually%20purchased%20the%20flat%20on%20January%203.\"} [:span \"[MOD4] A sequenced insertion performed on January 23: Eva actually purchased the flat on January 3.\"]] [:p [:span \"Now we are looking at [10.2.2] Sequenced Modifications within the book. For bitemporal tables, the modication is sequenced only on application time; the modication is always a current modification on system time, from now to until changed.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(insert! :prop-owner {:id 1\\n                      :customer-number 145\\n                      :property-number 7797\\n                      :application-time-start #inst \\\"1998-01-03\\\"\\n                      :application-time-end #inst \\\"1998-01-10\\\"})\", :nextjournal/opts {:loc {:line 512, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Look again\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(l {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\"  FOR ALL SYSTEM_TIME FOR ALL APPLICATION_TIME\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   5)\", :nextjournal/opts {:loc {:line 519, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:a {:href \\\"https://bitemporal-visualizer.github.io/?t=%7C+%3Acustomer_number+%7C++++++++%3Aapp_start+%7C++++++++++++++++++++%3Aapp_end+%7C++++++++++++++++++%3Asys_start+%7C++++++++++++++++++++%3Asys_end+%7C%0A%7C------------------%2B-------------------%2B-----------------------------%2B-----------------------------%2B-----------------------------%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.692186Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+++++++++++1998-01-15T00%3A00Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+++++++++++1998-01-20T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-03T00%3A00Z+%7C+++++++++++1998-01-10T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.322827Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A\\\", :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"This insertion is termed a retroactive modification, as the period of applicability is before the modification date Sequenced (and nonsequenced) modifications can also be postactive, an example being a promotion that will occur in the future (in application time).\"]] [:p [:span \"(An application-end time of \\\"forever\\\" is generally not considered a postactive modification; only the application-start time is considered.)\"]] [:p [:span \"A sequenced modification might even be simultaneously retroactive, postactive, and current, when its period of applicability starts in the past and extends into the future (e.g., a fixed-term assignment that started in the past and ends at a designated date in the future)\"]] [\"h4\" {:id \"%5BMOD5%5D%20We%20learn%20now%2026%20that%20Eva%20bought%20the%20flat%20not%20on%20January%2010...\"} [:span \"[MOD5] We learn now 26 that Eva bought the flat not on January 10...\"]] [:p [:span \"...as initially thought, nor on January 3, as later corrected, but on January 5. This requires a sequenced version of the following deletion:\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(with-open [my-conn (jdbc-conn)]\\n  (jdbc/execute! my-conn [\\\"SET APPLICATION_TIME_DEFAULTS TO AS_OF_NOW\\\"])\\n  (jdbc/execute! my-conn [\\\"\\nDELETE\\nFROM prop_owner\\nFOR PORTION OF APPLICATION_TIME\\nFROM DATE '1998-01-03' TO DATE '1998-01-05'\\\"]))\", :nextjournal/opts {:loc {:line 536, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :closing-paren (\\\"]\\\"), :page-size 20}, :nextjournal/value [], :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Look again\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(l {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\"  FOR ALL SYSTEM_TIME FOR ALL APPLICATION_TIME\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   6)\", :nextjournal/opts {:loc {:line 545, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:a {:href \\\"https://bitemporal-visualizer.github.io/?t=%7C+%3Acustomer_number+%7C++++++++%3Aapp_start+%7C++++++++++++++++++++%3Aapp_end+%7C++++++++++++++++++%3Asys_start+%7C++++++++++++++++++++%3Asys_end+%7C%0A%7C------------------%2B-------------------%2B-----------------------------%2B-----------------------------%2B-----------------------------%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.692186Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+++++++++++1998-01-15T00%3A00Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+++++++++++1998-01-20T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-03T00%3A00Z+%7C+++++++++++1998-01-10T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.322827Z+%7C+2022-11-30T14%3A18%3A31.405406Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-05T00%3A00Z+%7C+++++++++++1998-01-10T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.405406Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A\\\", :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"[MOD6] We next learn that Peter bought the flat on January 12...\"] [#viewer-eval v/inspect-presented {:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:span \" \"]}] [:span \"...not January 15 as previously thought. This requires a sequenced version of the following update. This update requires a period of applicability of January 12 through 15, setting the customer number to 145. Effectively, the ownership must be transferred from Eva to Peter for those three days.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(insert! :prop-owner {:id 1\\n                      :customer-number 145\\n                      :property-number 7797\\n                      :application-time-start #inst \\\"1998-01-05\\\"\\n                      :application-time-end #inst \\\"1998-01-12\\\"})\", :nextjournal/opts {:loc {:line 554, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(insert! :prop-owner {:id 1\\n                      :customer-number 827\\n                      :property-number 7797\\n                      :application-time-start #inst \\\"1998-01-12\\\"\\n                      :application-time-end #inst \\\"1998-01-20\\\"})\", :nextjournal/opts {:loc {:line 560, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [:p [:span \"Look again\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(l {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\"  FOR ALL SYSTEM_TIME FOR ALL APPLICATION_TIME\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   7)\", :nextjournal/opts {:loc {:line 567, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :html, :render-fn #viewer-fn v/html}, :nextjournal/value [:a {:href \\\"https://bitemporal-visualizer.github.io/?t=%7C+%3Acustomer_number+%7C++++++++%3Aapp_start+%7C++++++++++++++++++++%3Aapp_end+%7C++++++++++++++++++%3Asys_start+%7C++++++++++++++++++++%3Asys_end+%7C%0A%7C------------------%2B-------------------%2B-----------------------------%2B-----------------------------%2B-----------------------------%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.692186Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-10T00%3A00Z+%7C+++++++++++1998-01-15T00%3A00Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+2022-11-30T14%3A18%3A31.593401Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-12T00%3A00Z+%7C+++++++++++1998-01-15T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.593401Z+%7C+2022-11-30T14%3A18%3A31.657397Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C+2022-11-30T14%3A18%3A30.996587Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-15T00%3A00Z+%7C+++++++++++1998-01-20T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.164702Z+%7C+2022-11-30T14%3A18%3A31.657397Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-03T00%3A00Z+%7C+++++++++++1998-01-10T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.322827Z+%7C+2022-11-30T14%3A18%3A31.405406Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-05T00%3A00Z+%7C+++++++++++1998-01-10T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.405406Z+%7C+2022-11-30T14%3A18%3A31.593401Z+%7C%0A%7C++++++++++++++145+%7C+1998-01-05T00%3A00Z+%7C+++++++++++1998-01-12T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.593401Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A%7C++++++++++++++827+%7C+1998-01-12T00%3A00Z+%7C+++++++++++1998-01-20T00%3A00Z+%7C+2022-11-30T14%3A18%3A31.657397Z+%7C+9999-12-31T23%3A59%3A59.999999Z+%7C%0A\\\", :target \\\"_blank\\\"} \\\"[Open the Visualizer]\\\"], :path [], :nextjournal/expanded-at {[] false, nil false}}\", :nextjournal/viewer {:name :html}}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h3\" {:id \"%5B10.3.1%5D%20Time-Slice%20Queries\"} [:span \"[10.3.1] Time-Slice Queries\"]] [:p [:span \"A common query or view over the application-time state table is to capture the state of the enterprise at some point in the past (or future). This query is termed a application-time time-slice. For an auditable tracking log changes, we might seek to reconstruct the state of the monitored table as of a date in the past; this query is termed a system time-slice. As a bitemporal table captures application and system time, both time-slice variants are appropriate on such tables.\"]] [:p [:span \"Time-slices are useful also in understanding the information content of a bitemporal table. A system time-slice of a bitemporal table takes as input a system-time instant and results in a application-time state table that was present in the database at that specified time.\"]] [:p [:span \"A system time-slice query corresponds to a vertical slice in the time diagram.\"]] [:p [:span \"An application time-slice query corresponds to a horizontal slice as input application-time instant and results in a system-time in the time diagram.\"]] [:p [:span \"A bitemporal time-slice query extracts a single point from a time diagram, resulting in a snapshot table. A bitemporal time-slice takes as input two instants, a application-time and a system-time instant, and results in a snapshot state of the information regarding the enterprise at that application time, as recorded in the database at that system time. The result is the facts located at the intersection of the two lines, in this case, Eva.\"]] [:p [:span \"Give the owner of the flat at Skovvej 30 in Aalborg on January 13 as stored in the Prop Owner table on January 18.\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(q {:select (into [:x.customer-number]\\n                  time-cols)\\n    :from [[[:raw (str (sql/format-entity :prop-owner)\\n                       \\\"  FOR SYSTEM_TIME AS OF DATE '2099-01-01' FOR APPLICATION_TIME AS OF DATE '1998-01-13'\\\")] :x]]\\n    :where [[:= :x.id 1]]}\\n   8)\", :nextjournal/opts {:loc {:line 588, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn v/coll-viewer, :opening-paren \\\"[\\\", :page-size 20}, :nextjournal/value [{:nextjournal/viewer {:name :map, :render-fn #viewer-fn v/map-viewer, :opening-paren \\\"{\\\", :closing-paren (\\\"}\\\" \\\"]\\\"), :page-size 10}, :nextjournal/value [{:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :app_end, :path [0 0 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"1998-01-20T00:00Z\\\", :path [0 0 1]}], :path [0 0]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :app_start, :path [0 1 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"1998-01-12T00:00Z\\\", :path [0 1 1]}], :path [0 1]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :customer_number, :path [0 2 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/number-viewer}, :nextjournal/value 827, :path [0 2 1]}], :path [0 2]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :sys_end, :path [0 3 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"9999-12-31T23:59:59.999999Z\\\", :path [0 3 1]}], :path [0 3]} {:nextjournal/viewer {:name :map-entry, :render-fn #viewer-fn (fn [xs opts] (v/html (into [:<>] (comp (v/inspect-children opts) (interpose \\\" \\\")) xs))), :page-size 2}, :nextjournal/value [{:nextjournal/viewer {:render-fn #viewer-fn (fn [x] (v/html [:span.cmt-atom.inspected-value (str x)]))}, :nextjournal/value :sys_start, :path [0 4 0]} {:nextjournal/viewer {:render-fn #viewer-fn v/quoted-string-viewer, :page-size 80}, :nextjournal/value \\\"2022-11-30T14:18:31.657397Z\\\", :path [0 4 1]}], :path [0 4]}], :path [0]}], :path [], :nextjournal/expanded-at {[0 1 0] false, [0 0] false, [0 1 1] false, [0 4 1] false, [0 0 1] false, [] false, [0 2 0] false, [0] false, [0 3] false, [0 2] false, [0 4] false, [0 3 1] false, [0 3 0] false, [0 4 0] false, [0 0 0] false, [0 2 1] false, [0 1] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h3\" {:id \"And%20so%20on...\"} [:span \"And so on...\"]] [:p [:span \"Feel free to study and adapt the examples in snodgrass-99.sql as desired!\"]] [\"h2\" {:id \"Advanced%20HoneySQL%20and%20Beyond\"} [:span \"Advanced HoneySQL and Beyond\"]] [:p [:span \"... [WIP]\"]] [\"h3\" {:id \"Attempting%20to%20work%20around%20the%20(temporary)%20lack%20of%20an%20information%20schema...\"} [:span \"Attempting to work around the (temporary) lack of an information schema...\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn map-vals [f m] (reduce-kv (fn [m k v] (assoc m k (f v))) {} m))\", :nextjournal/opts {:loc {:line 605, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$map_vals 0x74b249b6 \\\\\\\"notebook$map_vals@74b249b6\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn insert!**\\n  \\\"overriding for-insert\\\"\\n  ([connectable table key-map]\\n   (insert!* connectable table key-map {}))\\n  ([connectable table key-map opts]\\n   (let [opts (merge (:options connectable) opts)\\n         key-map (assoc key-map :cols (str/join \\\" \\\" (map #(subs (str %) 1) (keys key-map))))]\\n     (prn (for-insert* table key-map opts))\\n     (jdbc/execute-one! connectable\\n                        (for-insert* table key-map opts)\\n                        (merge {:return-keys false} opts)))))\", :nextjournal/opts {:loc {:line 607, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$insert_BANG__STAR__STAR_ 0x116099ca \\\\\\\"notebook$insert_BANG__STAR__STAR_@116099ca\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(defn select-star-for-id [conn table id] ;; TODO use table\\n  ;; assumes as_of_now is already set\\n  #_(jdbc/execute-one! conn [ \\\"SET application_time_defaults TO as_of_now;\\\"])\\n  (letfn [(get-colls [conn id]\\n            (->> (some-> (jdbc/execute! conn (sql/format {:select :a.cols :from :a :where [:= :a.id id] :limit :1}))\\n                         first\\n                         :cols\\n            ;;             <-pgobject\\n                         (str/split #\\\" \\\"))\\n                 (map #(keyword \\\"a\\\" %))))]\\n    (let [colls (get-colls conn id)]\\n      colls\\n      (when (not-empty colls)\\n        (->> (jdbc/execute! conn (sql/format {:select colls\\n                                              :from :a :where [:= :a.id id] :limit :1}))\\n             first\\n             #_(map-vals <-pgobject))))))\", :nextjournal/opts {:loc {:line 619, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:name :read+inspect, :render-fn #viewer-fn (fn [x] (try (v/html [v/inspect (v/read-string x)]) (catch js/Error _e (v/unreadable-edn-viewer x))))}, :nextjournal/value \\\"#object[notebook$select_star_for_id 0x4186d064 \\\\\\\"notebook$select_star_for_id@4186d064\\\\\\\"]\\\", :path [], :nextjournal/expanded-at {[] false}}\", :nextjournal/viewer {:name :read+inspect}}, :path []} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(comment\\n  ;; remember: only JSON-shaped types can be round-tripped via pgwire (currently)!\\n  ;; we don't use `(with-meta m {:pgtype \\\"json\\\"})` as XT doesn't process actual JSON\\n  ;; DATEs (etc.) will be returned as ISO strings\\n  ;; don't use arrays yet (due to bugs), objects may also be buggy and cannot be compared\\n  ;; work with whole values only (don't attempt nested lookups, for now)\\n  ;; JSON string keys are returned as keywords\\n  ;; use snake_case for persistence interop (TODO reconfigure to use jdbc/snake-kebab-opts)\\n  ;; but consider next.jdbc builders: as-kebab-maps and as-unqualified-kebab-maps (see https://clojurians.slack.com/archives/C1Q164V29/p1662995380957559)\\n  (with-open [conn (jdbc-conn)]\\n    (jdbc/execute-one! conn [ \\\"SET application_time_defaults TO as_of_now;\\\"])\\n    (let [m1 {:id 1234 :name 4579999 :foo \\\"asdf\\\" :arr [9 1 [2 [1 3]]] :obj {:a {:b {:c 1 :d \\\"asdf\\\"} :e {:f 789 :g {:h 123}}}} :my_json3 {:a_f {:b \\\"c\\\"}} :my_date #inst \\\"1990-01-01\\\"}]\\n      (insert!** conn :a m1)\\n      (let [e (select-star-for-id conn :a (:id m1))]\\n        [(= e m1) e])))\\n\\n  (with-open [conn (jdbc-conn)]\\n    (jdbc/execute! conn [ \\\"SELECT x.my_json3 FROM a AS x (id, my_json3);\\\"]))\\n\\n  (with-open [conn (jdbc-conn)]\\n    (jdbc/execute! conn (sql/format {:select :a.id\\n                                     :from :a\\n                                     :where [:= :a.obj\\n                                             [:raw (-> {:c 1 :d \\\"asdf\\\"}\\n                                                       ->json\\n                                                       single-quotify)]]})))\\n\\n  )\", :nextjournal/opts {:loc {:line 637, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h3\" {:id \"HoneySQL%20Period%20Extensions\"} [:span \"HoneySQL Period Extensions\"]]]} {:nextjournal/viewer {:name :code, :render-fn #viewer-fn v/code-viewer}, :nextjournal/value \"(comment\\n  (def overlaps \\\"APP_TIME OVERLAPS\\\" :overlaps)\\n\\n  (sql/register-op! overlaps)\\n\\n  (sql/clause-order)\\n\\n  (sql/format {:select [:foo.name :bar.also_name]\\n               :from [[[:raw \\\"foo FOR ALL APPLICATION_TIME\\\"] :x] :bar]\\n               :for-system-time-as-of [:inline 123]\\n               :join-by [:left [[:baz]\\n                                [:using :id]]]\\n               :where [:overlaps :foo.APP_TIME :bar.APP_TIME]\\n               })\\n\\n  ;; interesting: https://github.com/strojure/parsesso/blob/default/test/demo/honeysql_select.clj\\n\\n  )\", :nextjournal/opts {:loc {:line 668, :column 1}}} {:nextjournal/viewer {:name :clerk/result, :render-fn #viewer-fn v/result-viewer}, :nextjournal/value {:nextjournal/edn \"{:nextjournal/viewer {:render-fn #viewer-fn (fn [_] (v/html [:span.cmt-default.inspected-value \\\"nil\\\"]))}, :nextjournal/value nil, :path [], :nextjournal/expanded-at {[] false}}\"}, :path []} {:nextjournal/viewer {:name :html-, :render-fn #viewer-fn v/html}, :nextjournal/value [:div.viewer-markdown [\"h2\" {:id \"Static%20Build\"} [:span \"Static Build\"]] [:ol [:li [:<> [:span \"Clear the cache (clerk/clear-cache!) (or delete the \"] [:code [:span \".clerk\"]] [:span \" directory)\"]]] [:li [:<> [:code [:span \"clj -X:nextjournal/clerk\"]] [:span \" (and be sure to not save this namespace in parallel / trigger cache changes)\"]]] [:li [:<> [:span \"Browse at \"] [:code [:span \"public/build/src/notebook.html\"]]]]] [:p [:span \"Hopefully this can be published on \"] [:a {:href \"https://github.clerk.garden/\"} [:span \"https://github.clerk.garden/\"]] [:span \" soon!\"]]]}], :toc {:type :toc, :children [{:type :toc, :content [{:type :text, :text \"XTDB â€˜Core2â€™ + HoneySQL experiments\"}], :heading-level 1, :children [{:type :toc, :content [{:type :text, :text \"Powered by Clerk âš¡\"}], :heading-level 2} {:type :toc, :content [{:type :text, :text \"Booting up & REPL usage\"}], :heading-level 2} {:type :toc, :content [{:type :monospace, :content [{:type :text, :text \"next.jdbc\"}]} {:type :text, :text \" boilerplate\"}], :heading-level 2} {:type :toc, :content [{:type :text, :text \"Start a Core2 node\"}], :heading-level 2} {:type :toc, :content [{:type :text, :text \"Core2 101\"}], :heading-level 2, :children [{:type :toc, :content [{:type :text, :text \"Instant Schemaless Writes\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"First-Class Arrays and Objects\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"Enhanced SQL:2011\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"Cross-Time Queries\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"Native Apache Arrow\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"Complete Erasure\"}], :heading-level 3}]} {:type :toc, :content [{:type :text, :text \"Behaviours to be aware of\"}], :heading-level 2} {:type :toc, :content [{:type :text, :text \"HoneySQL 101\"}], :heading-level 2, :children [{:type :toc, :content [{:type :text, :text \"Temporary HoneySQL boilerplate\"}], :heading-level 3}]} {:type :toc, :content [{:type :text, :text \"SQL:2011 / \"} {:type :monospace, :content [{:type :text, :text \"snodgrass-99\"}]}], :heading-level 2, :children [{:type :toc, :content [{:type :text, :text \"Background (excerpt)\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"[10.2] MODIFICATIONS\"}], :heading-level 3, :children [{:type :toc, :content [{:type :text, :text \"[MOD1] Eva Nielsen buys the flat at Skovvej 30 in Aalborg on January 10, 1998.\"}], :heading-level 4} {:type :toc, :content [{:type :text, :text \"[MOD2] Peter Olsen buys the flat; this legal system transfers ownership from Eva to him\"}], :heading-level 4} {:type :toc, :content [{:type :text, :text \"[MOD3] We perform a current deletion when we find out that Peter has sold the property to someone else\"}], :heading-level 4} {:type :toc, :content [{:type :text, :text \"[MOD4] A sequenced insertion performed on January 23: Eva actually purchased the flat on January 3.\"}], :heading-level 4} {:type :toc, :content [{:type :text, :text \"[MOD5] We learn now 26 that Eva bought the flat not on January 10...\"}], :heading-level 4}]} {:type :toc, :content [{:type :text, :text \"[10.3.1] Time-Slice Queries\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"And so on...\"}], :heading-level 3}]} {:type :toc, :content [{:type :text, :text \"Advanced HoneySQL and Beyond\"}], :heading-level 2, :children [{:type :toc, :content [{:type :text, :text \"Attempting to work around the (temporary) lack of an information schema...\"}], :heading-level 3} {:type :toc, :content [{:type :text, :text \"HoneySQL Period Extensions\"}], :heading-level 3}]} {:type :toc, :content [{:type :text, :text \"Static Build\"}], :heading-level 2}]}]}, :toc-visibility true, :title \"XTDB â€˜Core2â€™ + HoneySQL experiments\", :scope {:namespace :notebook}}, :path [], :nextjournal/expanded-at {[] false}}}, :path->url {\"src/notebook.clj\" \"src/notebook.html\"}, :current-path \"src/notebook.clj\"}")
app.init(opts)
</script></body></html>